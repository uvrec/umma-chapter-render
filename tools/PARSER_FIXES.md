# Виправлення парсера Gitabase

## Проблема
Парсер **пропускав** українську транслітерацію та послівний переклад з Gitabase замість того щоб їх зберігати та нормалізувати.

## Виправлення в `playwright_parser.py`

### 1. Перейменовано поля для ясності
- `word_by_word` → `synonyms_ua` (послівний переклад українською)
- `transliteration` → `transliteration_ua` (українська транслітерація)
- Додано підтримку `transliteration_en` (англійська IAST)

### 2. Виправлено логіку парсингу в `parse_gitabase_verse()`

**Раніше:**
- Блоки з латинськими символами (українська транслітерація) повністю пропускалися
- Блоки схожі на транслітерацію просто викидалися

**Тепер:**
- Зберігаємо блоки з латиницею у `transliteration_ua`
- Зберігаємо українську транслітерацію для подальшої нормалізації
- Послівний переклад зберігається у `synonyms_ua`

### 3. Додано пріоритет джерел транслітерації

1. **Пріоритет 1**: Українська транслітерація з Gitabase (якщо є)
2. **Пріоритет 2**: Конвертація англійської IAST з Vedabase → українська

### 4. Оновлено нормалізатор `pre_import_normalizer.py`

- Додано підтримку нових полів `transliteration_ua` та `transliteration_en`
- Зберігається зворотна сумісність зі старим полем `transliteration`

## Виправлення в `pre_import_normalizer.py`

### Додані правила нормалізації

#### 1. Mojibake та спецсимволи
```python
'\ufeff': '',      # BOM
'\u00A0': ' ',     # non-breaking space
'\u2018': "'",     # smart quotes
'\u2019': "'",
'\u201C': '"',
'\u201D': '"',
'\u2013': '-',     # en dash
'\u2014': '—',     # em dash
'\r\n': '\n',      # Windows line endings
```

#### 2. Придихові приголосні
```python
"джг": "джх",
"Джг": "Джх",
"джджг": "джджх",    # ✅ НОВЕ: jjh → жджх
"Джджг": "Джджх",
```

#### 3. Апостроф після "н"
Правило: `н'` → `нь`, `Н'` → `Нь`

**Виключення** (де апостроф правильний):
- ачар'я, Ачар'я
- антар'ямі, Антар'ямі

Приклади:
- санн'ясі → санньясі
- Ніт'янанда → Нітьянанда

#### 4. Специфічні слова
```python
"проджджгіта": "проджджхіта",
"Ачйута": "Ачьюта",
"Адвайта": "Адваіта",
"Джгарікханда": "Джхарікханда",
"санн'ясі": "санньясі",
```

### Порядок застосування правил

Для **українських текстів** (synonyms, translation, commentary):
1. Mojibake заміни
2. Видалення артефактів Gitabase
3. Діакритика
4. Словникові заміни
5. **Апостроф після "н" → м'який знак** ✅ НОВЕ
6. Придихові приголосні (включно з джг→джх, джджг→джджх)

Для **транслітерації**:
1. Конвертація IAST → українська (якщо потрібно)
2. Діакритика
3. Придихові приголосні
4. **БЕЗ** словникових замін (залишаємо "нйа" як є)

## Результат

Тепер парсер **зберігає** українську транслітерацію та послівний переклад з Gitabase, і вони проходять через нормалізатор який застосовує всі правила з:
- `TRANSLITERATION_RULES.md`
- SQL функції `normalize_ukrainian_cc_texts`
- Frontend нормалізатори (`textNormalizer.ts`, `normalizeText.ts`)

## Тестування

Для тестування виправлень:
```bash
# Запустити парсер сервер
python3 tools/parse_server.py

# Або використати парсер безпосередньо
python3 tools/playwright_parser.py
```

Перевірити вірш SCC 3.7.1:
```
POST http://127.0.0.1:5003/admin/parse-web-chapter
{
  "lila": 3,
  "chapter": 7,
  "verse_ranges": "1",
  "vedabase_base": "https://vedabase.io/en/library/cc/antya/7/",
  "gitabase_base": "https://gitabase.com/ukr/CC/3/7"
}
```

Очікуваний результат:
- `transliteration_ua` заповнена українською транслітерацією з Gitabase
- `synonyms_ua` заповнена послівним перекладом
- Всі правила нормалізації застосовані (н' → нь, джг → джх, тощо)
